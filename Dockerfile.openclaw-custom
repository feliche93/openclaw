FROM coollabsio/openclaw:latest

# OpenClaw's built-in skill installer expects `bun` to be available
# (e.g. "Install mcporter (bun)"). The upstream runtime image does not ship bun,
# so we add it in this derived image for Coolify deployments.
RUN apt-get update \
  && DEBIAN_FRONTEND=noninteractive apt-get install -y --no-install-recommends \
    ca-certificates \
    curl \
    bzip2 \
    ffmpeg \
    gh \
    python3 \
    python3-pip \
    python3-venv \
  && rm -rf /var/lib/apt/lists/*

# restic (for volume backups to R2 via Coolify Scheduled Tasks)
ARG RESTIC_VERSION=0.17.3
RUN set -eux; \
  arch="$(uname -m)"; \
  case "$arch" in \
    x86_64) restic_arch="amd64" ;; \
    aarch64|arm64) restic_arch="arm64" ;; \
    *) echo "Unsupported architecture for restic: $arch" >&2; exit 1 ;; \
  esac; \
  url="https://github.com/restic/restic/releases/download/v${RESTIC_VERSION}/restic_${RESTIC_VERSION}_linux_${restic_arch}.bz2"; \
  curl -fsSL "$url" -o /tmp/restic.bz2; \
  bunzip2 /tmp/restic.bz2; \
  install -m 0755 /tmp/restic /usr/local/bin/restic; \
  rm -f /tmp/restic; \
  restic version

# Ensure Docker exposes a health status for Coolify to pick up.
# /healthz is served by the nginx proxy generated by entrypoint.sh.
HEALTHCHECK --interval=10s --timeout=3s --start-period=10s --retries=12 \
  CMD curl -fsS "http://localhost:${PORT:-8080}/healthz" >/dev/null || exit 1

# Infisical CLI (used for runtime secret injection via INFISICAL_TOKEN)
# Note: intentionally unpinned so each image build installs the latest release.
RUN set -eux; \
  arch="$(uname -m)"; \
  case "$arch" in \
    x86_64) go_arch="amd64" ;; \
    aarch64|arm64) go_arch="arm64" ;; \
    *) echo "Unsupported architecture for infisical: $arch" >&2; exit 1 ;; \
  esac; \
  version="$(node -e 'fetch("https://api.github.com/repos/Infisical/cli/releases/latest",{headers:{"User-Agent":"openclaw-coolify"}}).then(r=>r.json()).then(j=>process.stdout.write(String(j.tag_name||"").replace(/^v/,""))).catch(e=>{console.error(e);process.exit(1);})')"; \
  if [ -z "$version" ]; then echo "Failed to resolve latest Infisical CLI version" >&2; exit 1; fi; \
  url="https://github.com/Infisical/cli/releases/download/v${version}/cli_${version}_linux_${go_arch}.tar.gz"; \
  curl -fsSL "$url" -o /tmp/infisical.tgz; \
  tar -xzf /tmp/infisical.tgz -C /tmp infisical; \
  install -m 0755 /tmp/infisical /usr/local/bin/infisical; \
  rm -f /tmp/infisical.tgz /tmp/infisical; \
  infisical --version

RUN curl -fsSL https://bun.sh/install | bash \
  && ln -sf /root/.bun/bin/bun /usr/local/bin/bun \
  && ln -sf /root/.bun/bin/bunx /usr/local/bin/bunx

# Google Workspace CLI (gog)
# - Pin version for reproducible Coolify builds; override with --build-arg if needed.
ARG GOGCLI_VERSION=0.11.0
RUN set -eux; \
  arch="$(uname -m)"; \
  case "$arch" in \
    x86_64) go_arch="amd64" ;; \
    aarch64|arm64) go_arch="arm64" ;; \
    *) echo "Unsupported architecture for gogcli: $arch" >&2; exit 1 ;; \
  esac; \
  url="https://github.com/steipete/gogcli/releases/download/v${GOGCLI_VERSION}/gogcli_${GOGCLI_VERSION}_linux_${go_arch}.tar.gz"; \
  curl -fsSL "$url" -o /tmp/gogcli.tgz; \
  tar -xzf /tmp/gogcli.tgz -C /tmp; \
  install -m 0755 /tmp/gog /usr/local/bin/gog; \
  rm -f /tmp/gogcli.tgz /tmp/gog; \
  gog --version

# Provide `mcporter` CLI inside the container so agents can use it and it survives restarts.
RUN npm i -g mcporter@0.7.3

# OpenClaw ships a bundled "coding-agent" skill that can drive Codex CLI, but the
# upstream image doesn't include the `codex` binary. Install it so the skill is
# eligible inside Coolify deployments.
#
# Note: intentionally unpinned so each image build installs the latest Codex CLI.
RUN npm i -g @openai/codex \
  && codex --version

# Provide the `whisper` CLI for the built-in OpenAI Whisper skill.
# This is a heavy dependency (pulls torch CPU wheels), but it makes the
# "Missing: bin:whisper" requirement pass inside the container.
RUN python3 -m venv /opt/whisper-venv \
  && /opt/whisper-venv/bin/pip install --no-cache-dir --prefer-binary openai-whisper \
  && ln -sf /opt/whisper-venv/bin/whisper /usr/local/bin/whisper

# Coolify deployment cannot reliably bind-mount individual files from the repo
# into the container. Bake the updated scripts into a derived image instead.
COPY scripts/entrypoint.sh /app/scripts/entrypoint.sh
COPY scripts/configure.js /app/scripts/configure.js
COPY scripts/redeploy-if-new-openclaw-release.sh /app/scripts/redeploy-if-new-openclaw-release.sh
COPY scripts/backup-openclaw-data-to-r2.sh /app/scripts/backup-openclaw-data-to-r2.sh
COPY scripts/restore-openclaw-data-from-r2.sh /app/scripts/restore-openclaw-data-from-r2.sh
COPY config/mcporter.container.json /app/config/mcporter.json

RUN chmod +x /app/scripts/entrypoint.sh \
  /app/scripts/redeploy-if-new-openclaw-release.sh \
  /app/scripts/backup-openclaw-data-to-r2.sh \
  /app/scripts/restore-openclaw-data-from-r2.sh
